name: Publish runners

on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: read
  packages: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.plan.outputs.version }}
      prev_version: ${{ steps.plan.outputs.prev_version }}
      build_runners: ${{ steps.plan.outputs.build_runners }}
      retag_runners: ${{ steps.plan.outputs.retag_runners }}
      changed_all: ${{ steps.plan.outputs.changed_all }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute build plan
        id: plan
        run: |
          set -eu
          VERSION="${GITHUB_REF_NAME}"
          printf "version=%s\n" "$VERSION" >> "$GITHUB_OUTPUT"

          # Discover all runner slugs from the repo layout.
          ALL_RUNNERS="$(find runners -maxdepth 2 -name Dockerfile -not -path 'runners/_common/*' -printf '%h\n' | sed 's#^runners/##' | sort)"

          PREV_VERSION=""
          if git describe --tags --abbrev=0 --match '*.*.*' --exclude "$VERSION" >/dev/null 2>&1; then
            PREV_VERSION="$(git describe --tags --abbrev=0 --match '*.*.*' --exclude "$VERSION")"
          fi
          printf "prev_version=%s\n" "$PREV_VERSION" >> "$GITHUB_OUTPUT"

          CHANGED_ALL="false"
          BUILD_RUNNERS=""
          RETAG_RUNNERS=""

          if [[ -z "$PREV_VERSION" ]]; then
            CHANGED_ALL="true"
            BUILD_RUNNERS="$ALL_RUNNERS"
          else
            CHANGED_FILES="$(git diff --name-only "$PREV_VERSION" "$GITHUB_SHA")"
            if printf '%s\n' "$CHANGED_FILES" | grep -qE '^runners/_common/'; then
              CHANGED_ALL="true"
              BUILD_RUNNERS="$ALL_RUNNERS"
            else
              BUILD_RUNNERS="$(printf '%s\n' "$CHANGED_FILES" | grep -E '^runners/[^/]+/' | cut -d/ -f2 | sort -u || true)"
              if [[ -z "$BUILD_RUNNERS" ]]; then
                # No runner changes: retag everything from previous version.
                RETAG_RUNNERS="$ALL_RUNNERS"
              else
                # Retag unchanged runners from the previous version so every release has a full set.
                RETAG_RUNNERS="$(comm -23 <(printf '%s\n' "$ALL_RUNNERS") <(printf '%s\n' "$BUILD_RUNNERS" | sort) || true)"
              fi
            fi
          fi

          printf "changed_all=%s\n" "$CHANGED_ALL" >> "$GITHUB_OUTPUT"

          export BUILD_RUNNERS RETAG_RUNNERS
          BUILD_JSON="$(python3 - <<'PY'
          import json, os
          items=[x for x in os.environ.get("BUILD_RUNNERS","").splitlines() if x.strip()]
          print(json.dumps(items))
          PY
          )"
          RETAG_JSON="$(python3 - <<'PY'
          import json, os
          items=[x for x in os.environ.get("RETAG_RUNNERS","").splitlines() if x.strip()]
          print(json.dumps(items))
          PY
          )"

          printf "build_runners=%s\n" "$BUILD_JSON" >> "$GITHUB_OUTPUT"
          printf "retag_runners=%s\n" "$RETAG_JSON" >> "$GITHUB_OUTPUT"

      - name: Validate manifest runner tags
        run: |
          set -eu
          python3 - <<'PY'
          import json, os, subprocess, sys
          import glob
          manifest_paths = sorted(glob.glob("catalog/*/manifest.json"))

          prev = os.environ.get("PREV_VERSION", "")
          if not prev:
            sys.exit(0)

          # Changed runner slugs are derived from git diff in the plan step.
          changed_json = os.environ.get("CHANGED_RUNNERS_JSON", "[]")
          try:
            changed = json.loads(changed_json)
          except json.JSONDecodeError:
            changed = []
          if not changed:
            sys.exit(0)

          for manifest_path in manifest_paths:
            # Load previous manifest from the tag if it existed.
            refs = f"refs/tags/{prev}:{manifest_path}"
            try:
              prev_raw = subprocess.check_output(["git", "show", refs], text=True)
              prev_manifest = json.loads(prev_raw)
            except subprocess.CalledProcessError:
              # New catalog added in this release; skip tag-change validation.
              continue

            with open(manifest_path, "r", encoding="utf-8") as fh:
              cur = json.load(fh)

            prev_runners = {r["slug"]: r.get("image") for r in prev_manifest.get("runners", [])}
            cur_runners = {r["slug"]: r.get("image") for r in cur.get("runners", [])}

            missing = [c for c in changed if c not in cur_runners]
            if missing:
              print(f"{manifest_path} missing changed runners: {', '.join(missing)}", file=sys.stderr)
              sys.exit(1)

            bad = []
            for slug in changed:
              if cur_runners.get(slug) == prev_runners.get(slug):
                bad.append(slug)
            if bad:
              print(
                f"{manifest_path} must update image tag for changed runners: "
                + ", ".join(bad),
                file=sys.stderr,
              )
              sys.exit(1)
          PY
        env:
          PREV_VERSION: ${{ steps.plan.outputs.prev_version }}
          CHANGED_RUNNERS_JSON: ${{ steps.plan.outputs.build_runners }}

  build-and-push:
    needs: plan
    if: needs.plan.outputs.changed_all == 'true' || needs.plan.outputs.build_runners != '[]'
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.build_runners) }}
        arch: [amd64, arm64]
        include:
          - arch: amd64
            platform: linux/amd64
            runs_on: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runs_on: ubuntu-24.04-arm

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve runner tag
        id: tag
        run: |
          set -eu
          python3 - <<'PY'
          import json, os, sys

          slug = os.environ["SLUG"]
          manifest_path = "catalog/v1/manifest.json"
          with open(manifest_path, "r", encoding="utf-8") as fh:
            data = json.load(fh)

          image = None
          for runner in data.get("runners", []):
            if runner.get("slug") == slug:
              image = runner.get("image")
              break
          if not image:
            print(f"runner '{slug}' not found in {manifest_path}", file=sys.stderr)
            sys.exit(1)

          if "@" in image:
            print(f"image '{image}' uses digest, not a tag", file=sys.stderr)
            sys.exit(1)

          tag = image.rsplit(":", 1)[-1] if ":" in image else ""
          if not tag or "/" in tag:
            print(f"image '{image}' has no tag suffix", file=sys.stderr)
            sys.exit(1)

          output_path = os.environ.get("GITHUB_OUTPUT")
          if not output_path:
            print(f"tag={tag}")
          else:
            with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"tag={tag}\n")
          PY
        env:
          SLUG: ${{ matrix.runner }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: runners/${{ matrix.runner }}/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ steps.tag.outputs.tag }}-${{ matrix.arch }}
          cache-from: type=gha,scope=${{ matrix.runner }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.runner }}-${{ matrix.arch }}

  manifest-built:
    needs: [plan, build-and-push]
    if: needs.plan.outputs.changed_all == 'true' || needs.plan.outputs.build_runners != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.build_runners) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve runner tag
        id: tag
        run: |
          set -eu
          python3 - <<'PY'
          import json, os, sys

          slug = os.environ["SLUG"]
          manifest_path = "catalog/v1/manifest.json"
          with open(manifest_path, "r", encoding="utf-8") as fh:
            data = json.load(fh)

          image = None
          for runner in data.get("runners", []):
            if runner.get("slug") == slug:
              image = runner.get("image")
              break
          if not image:
            print(f"runner '{slug}' not found in {manifest_path}", file=sys.stderr)
            sys.exit(1)

          if "@" in image:
            print(f"image '{image}' uses digest, not a tag", file=sys.stderr)
            sys.exit(1)

          tag = image.rsplit(":", 1)[-1] if ":" in image else ""
          if not tag or "/" in tag:
            print(f"image '{image}' has no tag suffix", file=sys.stderr)
            sys.exit(1)

          output_path = os.environ.get("GITHUB_OUTPUT")
          if not output_path:
            print(f"tag={tag}")
          else:
            with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"tag={tag}\n")
          PY
        env:
          SLUG: ${{ matrix.runner }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifest
        run: |
          set -eu
          image="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}"
          version="${{ steps.tag.outputs.tag }}"
          docker buildx imagetools create \
            -t "${image}:${version}" \
            -t "${image}:latest" \
            "${image}:${version}-amd64" \
            "${image}:${version}-arm64"

  retag-unchanged:
    needs: plan
    if: needs.plan.outputs.changed_all != 'true' && needs.plan.outputs.retag_runners != '[]' && needs.plan.outputs.prev_version != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.retag_runners) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve runner tags
        id: tags
        run: |
          set -eu
          python3 - <<'PY'
          import json, os, subprocess, sys

          slug = os.environ["SLUG"]
          prev = os.environ["PREV_VERSION"]
          manifest_path = "catalog/v1/manifest.json"

          with open(manifest_path, "r", encoding="utf-8") as fh:
            cur = json.load(fh)

          cur_image = None
          for runner in cur.get("runners", []):
            if runner.get("slug") == slug:
              cur_image = runner.get("image")
              break
          if not cur_image:
            print(f"runner '{slug}' not found in {manifest_path}", file=sys.stderr)
            sys.exit(1)

          try:
            prev_raw = subprocess.check_output(["git", "show", f"refs/tags/{prev}:{manifest_path}"], text=True)
            prev_manifest = json.loads(prev_raw)
          except subprocess.CalledProcessError as exc:
            print(f"failed to load previous manifest for tag '{prev}': {exc}", file=sys.stderr)
            sys.exit(1)

          prev_image = None
          for runner in prev_manifest.get("runners", []):
            if runner.get("slug") == slug:
              prev_image = runner.get("image")
              break
          if not prev_image:
            print(f"runner '{slug}' not found in previous manifest", file=sys.stderr)
            sys.exit(1)

          def tag_from(image):
            if "@" in image:
              return ""
            if ":" not in image:
              return ""
            return image.rsplit(":", 1)[-1]

          cur_tag = tag_from(cur_image)
          prev_tag = tag_from(prev_image)
          if not cur_tag or not prev_tag:
            print(f"runner '{slug}' missing tag in manifest image", file=sys.stderr)
            sys.exit(1)

          output_path = os.environ.get("GITHUB_OUTPUT")
          if not output_path:
            print(f"cur_tag={cur_tag}")
            print(f"prev_tag={prev_tag}")
          else:
            with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"cur_tag={cur_tag}\n")
              fh.write(f"prev_tag={prev_tag}\n")
          PY
        env:
          SLUG: ${{ matrix.runner }}
          PREV_VERSION: ${{ needs.plan.outputs.prev_version }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag unchanged image
        run: |
          set -eu
          src="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ steps.tags.outputs.prev_tag }}"
          dst="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ steps.tags.outputs.cur_tag }}"
          if [ "$src" != "$dst" ]; then
            docker buildx imagetools create -t "$dst" "$src"
          fi
          docker buildx imagetools create -t "ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:latest" "$dst"
