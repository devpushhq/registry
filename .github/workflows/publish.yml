name: Publish runners

on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: read
  packages: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.plan.outputs.version }}
      prev_version: ${{ steps.plan.outputs.prev_version }}
      build_runners: ${{ steps.plan.outputs.build_runners }}
      retag_runners: ${{ steps.plan.outputs.retag_runners }}
      changed_all: ${{ steps.plan.outputs.changed_all }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute build plan
        id: plan
        run: |
          set -eu
          VERSION="${GITHUB_REF_NAME}"
          printf "version=%s\n" "$VERSION" >> "$GITHUB_OUTPUT"

          # Discover all runner slugs from the repo layout.
          ALL_RUNNERS="$(find runners -maxdepth 2 -name Dockerfile -not -path 'runners/_common/*' -printf '%h\n' | sed 's#^runners/##' | sort)"

          PREV_VERSION=""
          if git describe --tags --abbrev=0 --match '*.*.*' "${GITHUB_SHA}^" >/dev/null 2>&1; then
            PREV_VERSION="$(git describe --tags --abbrev=0 --match '*.*.*' "${GITHUB_SHA}^")"
          fi
          printf "prev_version=%s\n" "$PREV_VERSION" >> "$GITHUB_OUTPUT"

          CHANGED_ALL="false"
          BUILD_RUNNERS=""
          RETAG_RUNNERS=""

          if [[ -z "$PREV_VERSION" ]]; then
            CHANGED_ALL="true"
            BUILD_RUNNERS="$ALL_RUNNERS"
          else
            CHANGED_FILES="$(git diff --name-only "$PREV_VERSION" "$GITHUB_SHA")"
            if printf '%s\n' "$CHANGED_FILES" | grep -qE '^runners/_common/'; then
              CHANGED_ALL="true"
              BUILD_RUNNERS="$ALL_RUNNERS"
            else
              BUILD_RUNNERS="$(printf '%s\n' "$CHANGED_FILES" | grep -E '^runners/[^/]+/' | cut -d/ -f2 | sort -u || true)"
              if [[ -z "$BUILD_RUNNERS" ]]; then
                # No runner changes: retag everything from previous version.
                RETAG_RUNNERS="$ALL_RUNNERS"
              else
                # Retag unchanged runners from the previous version so every release has a full set.
                RETAG_RUNNERS="$(comm -23 <(printf '%s\n' "$ALL_RUNNERS") <(printf '%s\n' "$BUILD_RUNNERS" | sort) || true)"
              fi
            fi
          fi

          printf "changed_all=%s\n" "$CHANGED_ALL" >> "$GITHUB_OUTPUT"

          export BUILD_RUNNERS RETAG_RUNNERS
          BUILD_JSON="$(python3 - <<'PY'
          import json, os
          items=[x for x in os.environ.get("BUILD_RUNNERS","").splitlines() if x.strip()]
          print(json.dumps(items))
          PY
          )"
          RETAG_JSON="$(python3 - <<'PY'
          import json, os
          items=[x for x in os.environ.get("RETAG_RUNNERS","").splitlines() if x.strip()]
          print(json.dumps(items))
          PY
          )"

          printf "build_runners=%s\n" "$BUILD_JSON" >> "$GITHUB_OUTPUT"
          printf "retag_runners=%s\n" "$RETAG_JSON" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: plan
    if: needs.plan.outputs.changed_all == 'true' || needs.plan.outputs.build_runners != '[]'
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.build_runners) }}
        arch: [amd64, arm64]
        include:
          - arch: amd64
            platform: linux/amd64
            runs_on: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runs_on: ubuntu-24.04-arm

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: runners/${{ matrix.runner }}/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ needs.plan.outputs.version }}-${{ matrix.arch }}
          cache-from: type=gha,scope=${{ matrix.runner }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.runner }}-${{ matrix.arch }}

  manifest-built:
    needs: [plan, build-and-push]
    if: needs.plan.outputs.changed_all == 'true' || needs.plan.outputs.build_runners != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.build_runners) }}

    steps:
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifest
        run: |
          set -eu
          image="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}"
          version="${{ needs.plan.outputs.version }}"
          docker buildx imagetools create \
            -t "${image}:${version}" \
            -t "${image}:latest" \
            "${image}:${version}-amd64" \
            "${image}:${version}-arm64"

  retag-unchanged:
    needs: plan
    if: needs.plan.outputs.changed_all != 'true' && needs.plan.outputs.retag_runners != '[]' && needs.plan.outputs.prev_version != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.plan.outputs.retag_runners) }}

    steps:
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag unchanged image
        run: |
          set -eu
          src="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ needs.plan.outputs.prev_version }}"
          dst="ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:${{ needs.plan.outputs.version }}"
          docker buildx imagetools create -t "$dst" "$src"
          docker buildx imagetools create -t "ghcr.io/${{ github.repository_owner }}/runner-${{ matrix.runner }}:latest" "$dst"
